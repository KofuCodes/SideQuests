<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuestMap - Adventure Together</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Auth Screen -->
  <div id="authScreen" class="auth-screen">
    <div class="auth-container">
      <div class="auth-brand">
        <img src="../assets/logo/logo.png" alt="QuestMap" class="auth-logo-img" />
        <h1>QuestMap</h1>
        <p>Collect moments. Level up IRL.</p>
      </div>

      <div class="auth-tabs">
        <button type="button" class="auth-tab active" data-tab="login">Login</button>
        <button type="button" class="auth-tab" data-tab="signup">Sign Up</button>
      </div>

      <form id="loginForm" class="auth-form">
        <input type="email" id="loginEmail" placeholder="Email" required />
        <input type="password" id="loginPassword" placeholder="Password" required />
        <button type="submit" class="btn primary">Log In</button>
      </form>

      <form id="signupForm" class="auth-form hidden">
        <input type="text" id="signupUsername" placeholder="Username" required />
        <input type="email" id="signupEmail" placeholder="Email" required />
        <input type="password" id="signupPassword" placeholder="Password" required />
        <button type="submit" class="btn primary">Create Account</button>
      </form>

      <div id="authError" class="auth-error hidden"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <!-- Top Navigation -->
    <nav class="navbar">
      <div class="nav-left">
        <img src="../assets/logo/logo.png" alt="QuestMap" class="navbar-logo-img" />
        <div class="nav-info">
          <div class="nav-title">SideQuest</div>
          <div class="nav-subtitle" id="userDisplayName">Explorer</div>
        </div>
      </div>

      <div class="nav-center">
        <div class="nav-stats">
          <div class="stat-item">
            <span class="stat-label">Total XP</span>
            <span class="stat-value" id="totalXP">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Quests</span>
            <span class="stat-value" id="totalQuests">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Friends</span>
            <span class="stat-value" id="friendCount">0</span>
          </div>
        </div>
      </div>

      <div class="nav-right">
        <button class="icon-btn" id="openCircles" title="Circles">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
            <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
            <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
          </svg>
        </button>
        <button class="icon-btn" id="openProfile" title="Profile">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
          </svg>
        </button>
        <button class="btn ghost small" id="logoutBtn">Logout</button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="app-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-section">
          <h3>Badges</h3>
          <div id="badgeFilters" class="badge-grid"></div>
        </div>

        <div class="sidebar-section">
          <div id="progressCard" class="progress-card">
            <div class="progress-header">
              <span id="progressBadge">Select a badge</span>
              <span id="progressRank" class="rank-badge">â€”</span>
            </div>
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="progress-info">
              <span id="progressXP">0 XP</span>
              <span id="progressNext">â€”</span>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Active Circles</h3>
          <div id="activeCircles" class="circles-list"></div>
        </div>

        <div class="sidebar-section">
          <h3>Recent Activity</h3>
          <div id="recentActivity" class="activity-feed"></div>
        </div>
      </aside>

      <!-- Map Area -->
      <main class="map-container">
        <div id="map" class="map"></div>
        
        <!-- Quest Drawer -->
        <div id="questDrawer" class="quest-drawer hidden">
          <div class="drawer-inner">
            <div class="drawer-badge" id="drawerBadge">â€”</div>
            <div class="drawer-info">
              <span id="drawerXP">â€”</span>
            </div>
            <h2 id="drawerTitle">Quest Title</h2>
            <label class="btn secondary file-upload">
              ðŸ“· Upload Photo
              <input type="file" id="photoUpload" accept="image/*" hidden />
            </label>
            <div id="photoPreview" class="photo-preview hidden">
              <img id="previewImg" src="" alt="Preview" />
            </div>
          </div>
          <button class="icon-btn close-btn" id="closeDrawer">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
          </button>
        </div>
      </main>
    </div>
  </div>

  <!-- Circles Modal -->
  <div id="circlesModal" class="modal hidden">
    <div class="modal-content large">
      <div class="modal-header">
        <h2>Your Circles</h2>
        <button class="icon-btn" id="closeCirclesModal">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="circles-tabs">
          <button class="circles-tab active" data-tab="myCircles">My Circles</button>
          <button class="circles-tab" data-tab="friends">Friends</button>
          <button class="circles-tab" data-tab="requests">Requests</button>
        </div>

        <div id="myCirclesTab" class="circles-tab-content">
          <button class="btn primary" id="createCircle">+ Create New Circle</button>
          <div id="circlesList" class="circles-grid"></div>
        </div>

        <div id="friendsTab" class="circles-tab-content hidden">
          <div class="search-box">
            <input type="text" id="friendSearch" placeholder="Search by username..." />
            <button class="btn primary" id="sendFriendRequest">Send Request</button>
          </div>
          <div id="friendsList" class="friends-list"></div>
        </div>

        <div id="requestsTab" class="circles-tab-content hidden">
          <div id="requestsList" class="requests-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Profile</h2>
        <button class="icon-btn" id="closeProfileModal">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="profile-header">
          <div class="profile-avatar">
            <span id="profileInitial">U</span>
          </div>
          <div class="profile-info">
            <h3 id="profileUsername">Username</h3>
            <p id="profileEmail">email@example.com</p>
          </div>
        </div>

        <div class="profile-stats">
          <div class="profile-stat">
            <div class="profile-stat-value" id="profileTotalXP">0</div>
            <div class="profile-stat-label">Total XP</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="profileCompletedQuests">0</div>
            <div class="profile-stat-label">Completed</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="profileCircles">0</div>
            <div class="profile-stat-label">Circles</div>
          </div>
        </div>

        <div class="badge-progress-list">
          <h4>Badge Progress</h4>
          <div id="profileBadges"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Circle Modal -->
  <div id="createCircleModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create Circle</h2>
        <button class="icon-btn" id="closeCreateCircle">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <form id="createCircleForm">
          <div class="form-group">
            <label>Circle Name</label>
            <input type="text" id="circleName" placeholder="Weekend Warriors" required />
          </div>
          
          <div class="form-group">
            <label>Description</label>
            <textarea id="circleDescription" placeholder="What's this circle about?" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>XP Multiplier</label>
            <select id="circleMultiplier">
              <option value="1.25">1.25x (2-3 people)</option>
              <option value="1.5">1.5x (4-5 people)</option>
              <option value="1.75">1.75x (6+ people)</option>
            </select>
          </div>

          <button type="submit" class="btn primary full-width">Create Circle</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Critical external libraries loaded first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Core app modules loaded in dependency order with defer for non-blocking parsing -->
  <script src="config.js" defer></script>
  <script src="utils.js" defer></script>
  <script src="auth.js" defer></script>
  <script src="map.js" defer></script>
  <script src="ui.js" defer></script>
  <script src="app-main.js" defer></script>
</body>
</html>